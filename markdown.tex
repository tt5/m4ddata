%
%%The `markdown` Lua module exposes the `new(`\meta{options}`)` method, which
%%creates a converter function from markdown to \TeX{}. The properties of the
%%converter function are specified by the Lua table `options`. The parameter is
%%optional; when unspecified, the behaviour will be the same as if \meta{options}
%%were an empty table.
%
%\csname newread\endcsname\markdownInputFileStream
%\csname newwrite\endcsname\markdownOutputFileStream
%
%\def\markdownOptionHelperScriptFileName{\jobname.markdown.lua}%
%%\def\markdownOptionHelperScriptFileName{test.markdown.lua}%
%\def\markdownOptionInputTempFileName{\jobname.markdown.in}%
%\def\markdownOptionOutputTempFileName{\jobname.markdown.out}%
%\def\markdownOptionErrorTempFileName{\jobname.markdown.err}%
%\def\markdownOptionOutputDir{.}%
%\def\markdownOptionCacheDir{\markdownOptionOutputDir/_markdown_\jobname}%
%%\def\markdownOptionCacheDir{\markdownOptionOutputDir/_markdown_test}%
%
%\let\markdownOptionBlankBeforeBlockquote\undefined
%\let\markdownOptionBlankBeforeCodeFence\undefined
%\let\markdownOptionBlankBeforeHeading\undefined
%\let\markdownOptionBreakableBlockquotes\undefined
%\let\markdownOptionCitations\undefined
%\let\markdownOptionCitationNbsps\undefined
%\let\markdownOptionContentBlocks\undefined
%\let\markdownOptionContentBlocksLanguageMap\undefined
%\let\markdownOptionDefinitionLists\undefined
%\let\markdownOptionFootnotes\undefined
%\let\markdownOptionFencedCode\undefined
%\let\markdownOptionHashEnumerators\undefined
%\let\markdownOptionHeaderAttributes\undefined
%\let\markdownOptionHtml\undefined
%\let\markdownOptionHybrid\undefined
%\let\markdownOptionInlineFootnotes\undefined
%\let\markdownOptionPipeTables\undefined
%\let\markdownOptionPreserveTabs\undefined
%\let\markdownOptionShiftHeadings\undefined
%\let\markdownOptionSlice\undefined
%\let\markdownOptionSmartEllipses\undefined
%\let\markdownOptionStartNumber\undefined
%\let\markdownOptionTableCaptions\undefined
%\let\markdownOptionTightLists\undefined
%
%\def\markdownOptionStripPercentSigns{false}%
%
%\def\markdownIfOption#1{%
%  \def\next##1##2##3##4##5{%
%    \expandafter\def\expandafter\next\expandafter{%
%      \csname iffalse\endcsname}%
%    \if##1t\if##2r\if##3u\if##4e
%      \expandafter\def\expandafter\next\expandafter{%
%        \csname iftrue\endcsname}%
%    \fi\fi\fi\fi
%    \next}%
%  \expandafter\expandafter\expandafter\next
%    \csname markdownOption#1\endcsname\relax\relax\relax\relax\relax}
%
\def\markdownRendererInterblockSeparatorPrototype{}%
\def\markdownRendererLineBreakPrototype{}%
%\def\markdownRendererEllipsisPrototype{}%
%\def\markdownRendererNbspPrototype{}%
\def\markdownRendererLeftBracePrototype{}%
\def\markdownRendererRightBracePrototype{}%
\def\markdownRendererDollarSignPrototype{}%
\def\markdownRendererPercentSignPrototype{}%
\def\markdownRendererAmpersandPrototype{}%
\def\markdownRendererUnderscorePrototype{}%
\def\markdownRendererHashPrototype{}%
\def\markdownRendererCircumflexPrototype{}%
\def\markdownRendererBackslashPrototype{}%
\def\markdownRendererTildePrototype{}%
\def\markdownRendererPipePrototype{}%
\def\markdownRendererCodeSpanPrototype#1{}%
%\def\markdownRendererLinkPrototype#1#2#3#4{}%
%\def\markdownRendererImagePrototype#1#2#3#4{}%
%\def\markdownRendererContentBlockPrototype#1#2#3#4{}%
%\def\markdownRendererContentBlockOnlineImagePrototype#1#2#3#4{}%
%\def\markdownRendererContentBlockCodePrototype#1#2#3#4#5{}%
%\def\markdownRendererUlBeginPrototype{}%
%\def\markdownRendererUlBeginTightPrototype{}%
%\def\markdownRendererUlItemPrototype{}%
%\def\markdownRendererUlItemEndPrototype{}%
%\def\markdownRendererUlEndPrototype{}%
%\def\markdownRendererUlEndTightPrototype{}%
%\def\markdownRendererOlBeginPrototype{}%
%\def\markdownRendererOlBeginTightPrototype{}%
%\def\markdownRendererOlItemPrototype{}%
%\def\markdownRendererOlItemWithNumberPrototype#1{}%
%\def\markdownRendererOlItemEndPrototype{}%
%\def\markdownRendererOlEndPrototype{}%
%\def\markdownRendererOlEndTightPrototype{}%
%\def\markdownRendererDlBeginPrototype{}%
%\def\markdownRendererDlBeginTightPrototype{}%
%\def\markdownRendererDlItemPrototype#1{}%
%\def\markdownRendererDlItemEndPrototype{}%
%\def\markdownRendererDlDefinitionBeginPrototype{}%
%\def\markdownRendererDlDefinitionEndPrototype{}%
%\def\markdownRendererDlEndPrototype{}%
%\def\markdownRendererDlEndTightPrototype{}%
\def\markdownRendererEmphasisPrototype#1{}%
\def\markdownRendererStrongEmphasisPrototype#1{}%
%\def\markdownRendererBlockQuoteBeginPrototype{}%
%\def\markdownRendererBlockQuoteEndPrototype{}%
%\def\markdownRendererInputVerbatimPrototype#1{}%
\def\markdownRendererInputFencedCodePrototype#1#2{}%
\def\markdownRendererHeadingOnePrototype#1{}%
\def\markdownRendererHeadingTwoPrototype#1{}%
\def\markdownRendererHeadingThreePrototype#1{}%
\def\markdownRendererHeadingFourPrototype#1{}%
\def\markdownRendererHeadingFivePrototype#1{}%
\def\markdownRendererHeadingSixPrototype#1{}%
%\def\markdownRendererHorizontalRulePrototype{}%
%\def\markdownRendererFootnotePrototype#1{}%
%\def\markdownRendererCitePrototype#1{}%
%\def\markdownRendererTextCitePrototype#1{}%
%\def\markdownRendererTablePrototype#1#2#3{}%
%
%\def\markdownInfo#1{}%
%\def\markdownWarning#1{}%
%\def\markdownError#1#2{}%
%
%\let\markdownMakeOther\relax
%
%\let\markdownReadAndConvert\relax
%
%\begingroup
%  \catcode`\|=0\catcode`\\=12%
%  |gdef|markdownBegin{%
%    |markdownReadAndConvert{\markdownEnd}%
%                           {|markdownEnd}}%
%|endgroup
%
%\newenvironment{markdown}\relax\relax
%\newenvironment{markdown*}[1]\relax\relax
%
%\def\markdownInfo#1{%
%  \immediate\write-1{(l.\the\inputlineno) markdown.tex info: #1.}}%
%\def\markdownWarning#1{%
%  \immediate\write16{(l.\the\inputlineno) markdown.tex warning: #1}}%
%\def\markdownError#1#2{%
%  \errhelp{#2.}%
%  \errmessage{(l.\the\inputlineno) markdown.tex error: #1}}%
%
\def\markdownRendererInterblockSeparatorPrototype{\par}%
\def\markdownRendererLineBreakPrototype{\hfil\break}%
%\let\markdownRendererEllipsisPrototype\dots
%\def\markdownRendererNbspPrototype{~}%
\def\markdownRendererLeftBracePrototype{\char`\{}%
\def\markdownRendererRightBracePrototype{\char`\}}%
%\def\markdownRendererDollarSignPrototype{\char`$}%
\def\markdownRendererDollarSignPrototype{\dollar}%
%\def\markdownRendererDollarSignPrototype{$}%
\def\markdownRendererPercentSignPrototype{\char`\%}%
\def\markdownRendererAmpersandPrototype{\&}%
\def\markdownRendererUnderscorePrototype{\char`_}%
\def\markdownRendererHashPrototype{\char`\#}%
\def\markdownRendererCircumflexPrototype{\char`^}%
\def\markdownRendererBackslashPrototype{\char`\\}%
\def\markdownRendererTildePrototype{\char`~}%
\def\markdownRendererPipePrototype{|}%
\def\markdownRendererCodeSpanPrototype#1{{\texttt{#1}}}%
%
%%\def\markdownRendererLinkPrototype#1#2#3#4{#2}%
%\def\markdownRendererLinkPrototype#1#2#3#4{}%
%
%\def\markdownRendererContentBlockPrototype#1#2#3#4{%
%  \markdownInput{#3}}%
%\def\markdownRendererContentBlockOnlineImagePrototype{%
%  \markdownRendererImage}%
%\def\markdownRendererContentBlockCodePrototype#1#2#3#4#5{%
%  \markdownRendererInputFencedCode{#3}{#2}}%
%\def\markdownRendererImagePrototype#1#2#3#4{#2}%
%\def\markdownRendererUlBeginPrototype{}%
%\def\markdownRendererUlBeginTightPrototype{}%
%\def\markdownRendererUlItemPrototype{}%
%\def\markdownRendererUlItemEndPrototype{}%
%\def\markdownRendererUlEndPrototype{}%
%\def\markdownRendererUlEndTightPrototype{}%
%\def\markdownRendererOlBeginPrototype{}%
%\def\markdownRendererOlBeginTightPrototype{}%
%\def\markdownRendererOlItemPrototype{}%
%\def\markdownRendererOlItemWithNumberPrototype#1{}%
%\def\markdownRendererOlItemEndPrototype{}%
%\def\markdownRendererOlEndPrototype{}%
%\def\markdownRendererOlEndTightPrototype{}%
%\def\markdownRendererDlBeginPrototype{}%
%\def\markdownRendererDlBeginTightPrototype{}%
%\def\markdownRendererDlItemPrototype#1{#1}%
%\def\markdownRendererDlItemEndPrototype{}%
%\def\markdownRendererDlDefinitionBeginPrototype{}%
%\def\markdownRendererDlDefinitionEndPrototype{\par}%
%\def\markdownRendererDlEndPrototype{}%
%\def\markdownRendererDlEndTightPrototype{}%
\def\markdownRendererEmphasisPrototype#1{\emph{#1}}%
%\def\markdownRendererStrongEmphasisPrototype#1{{\bfseries#1}}%
\def\markdownRendererStrongEmphasisPrototype#1{\textbf{#1}}%
%
%\def\markdownRendererEmphasis#1{\emph{#1}}
%\def\markdownRendererStrongEmphasis#1{\textbf{#1}}
%
%\def\markdownRendererBlockQuoteBeginPrototype{\par\begingroup\itshape}%
%\def\markdownRendererBlockQuoteEndPrototype{\endgroup\par}%
\def\markdownRendererInputVerbatimPrototype#1{%
      \ttfamily\small
      \input{|"./m4ddata/codeblock.sh #1"}
      \normalfont\normalsize
  }%
%\def\markdownRendererInputFencedCodePrototype#1#2{%
%  \markdownRendererInputVerbatimPrototype{#1}}%
\def\markdownRendererInputFencedCodePrototype#1#2{%
  \markdownRendererInputVerbatimPrototype{#1}}%
\def\markdownRendererHeadingOnePrototype#1{\section{#1}}%
\def\markdownRendererHeadingTwoPrototype#1{\subsection{#1}}%
\def\markdownRendererHeadingThreePrototype#1{\subsubsection{#1}}%
\def\markdownRendererHeadingFourPrototype#1{#1}%
\def\markdownRendererHeadingFivePrototype#1{#1}%
\def\markdownRendererHeadingSixPrototype#1{#1}%
%\def\markdownRendererHorizontalRulePrototype{}%
%\def\markdownRendererFootnotePrototype#1{#1}%
%\def\markdownRendererCitePrototype#1{}%
%\def\markdownRendererTextCitePrototype#1{}%
%
%
%\def\markdownRendererNbsp{%
%  \markdownRendererNbspPrototype}%
\def\markdownRendererLeftBrace{%
  \markdownRendererLeftBracePrototype}%
\def\markdownRendererRightBrace{%
  \markdownRendererRightBracePrototype}%
\def\markdownRendererDollarSign{%
  \markdownRendererDollarSignPrototype}%
\def\markdownRendererPercentSign{%
  \markdownRendererPercentSignPrototype}%
\def\markdownRendererAmpersand{%
  \markdownRendererAmpersandPrototype}%
\def\markdownRendererUnderscore{%
  \markdownRendererUnderscorePrototype}%
\def\markdownRendererHash{%
  \markdownRendererHashPrototype}%
\def\markdownRendererCircumflex{%
  \markdownRendererCircumflexPrototype}%
\def\markdownRendererBackslash{%
  \markdownRendererBackslashPrototype}%
\def\markdownRendererTilde{%
  \markdownRendererTildePrototype}%
\def\markdownRendererPipe{%
  \markdownRendererPipePrototype}%
%\def\markdownRendererImage{%
%  \markdownRendererImagePrototype}%
%\def\markdownRendererContentBlock{%
%  \markdownRendererContentBlockPrototype}%
%\def\markdownRendererContentBlockOnlineImage{%
%  \markdownRendererContentBlockOnlineImagePrototype}%
%\def\markdownRendererContentBlockCode{%
%  \markdownRendererContentBlockCodePrototype}%
%\def\markdownRendererUlBegin{%
%  \markdownRendererUlBeginPrototype}%
%\def\markdownRendererUlBeginTight{%
%  \markdownRendererUlBeginTightPrototype}%
%\def\markdownRendererUlItem{%
%  \markdownRendererUlItemPrototype}%
%\def\markdownRendererUlItemEnd{%
%  \markdownRendererUlItemEndPrototype}%
%\def\markdownRendererUlEnd{%
%  \markdownRendererUlEndPrototype}%
%\def\markdownRendererUlEndTight{%
%  \markdownRendererUlEndTightPrototype}%
%\def\markdownRendererOlBegin{%
%  \markdownRendererOlBeginPrototype}%
%\def\markdownRendererOlBeginTight{%
%  \markdownRendererOlBeginTightPrototype}%
%\def\markdownRendererOlItem{%
%  \markdownRendererOlItemPrototype}%
%\def\markdownRendererOlItemEnd{%
%  \markdownRendererOlItemEndPrototype}%
%\def\markdownRendererOlItemWithNumber{%
%  \markdownRendererOlItemWithNumberPrototype}%
%\def\markdownRendererOlEnd{%
%  \markdownRendererOlEndPrototype}%
%\def\markdownRendererOlEndTight{%
%  \markdownRendererOlEndTightPrototype}%
%\def\markdownRendererDlBegin{%
%  \markdownRendererDlBeginPrototype}%
%\def\markdownRendererDlBeginTight{%
%  \markdownRendererDlBeginTightPrototype}%
%\def\markdownRendererDlItem{%
%  \markdownRendererDlItemPrototype}%
%\def\markdownRendererDlItemEnd{%
%  \markdownRendererDlItemEndPrototype}%
%\def\markdownRendererDlDefinitionBegin{%
%  \markdownRendererDlDefinitionBeginPrototype}%
%\def\markdownRendererDlDefinitionEnd{%
%  \markdownRendererDlDefinitionEndPrototype}%
%\def\markdownRendererDlEnd{%
%  \markdownRendererDlEndPrototype}%
%\def\markdownRendererDlEndTight{%
%  \markdownRendererDlEndTightPrototype}%
\def\markdownRendererEmphasis{%
  \markdownRendererEmphasisPrototype}%
\def\markdownRendererStrongEmphasis{%
  \markdownRendererStrongEmphasisPrototype}%
%\def\markdownRendererBlockQuoteBegin{%
%  \markdownRendererBlockQuoteBeginPrototype}%
%\def\markdownRendererBlockQuoteEnd{%
%  \markdownRendererBlockQuoteEndPrototype}%
%\def\markdownRendererInputVerbatim{%
%  \markdownRendererInputVerbatimPrototype}%
\def\markdownRendererInputFencedCode{%
  \markdownRendererInputFencedCodePrototype}%
\def\markdownRendererHeadingOne{%
  \markdownRendererHeadingOnePrototype}%
\def\markdownRendererHeadingTwo{%
  \markdownRendererHeadingTwoPrototype}%
\def\markdownRendererHeadingThree{%
  \markdownRendererHeadingThreePrototype}%
\def\markdownRendererHeadingFour{%
  \markdownRendererHeadingFourPrototype}%
\def\markdownRendererHeadingFive{%
  \markdownRendererHeadingFivePrototype}%
\def\markdownRendererHeadingSix{%
  \markdownRendererHeadingSixPrototype}%
%\def\markdownRendererFootnote{%
%  \markdownRendererFootnotePrototype}%
%\def\markdownRendererCite{%
%  \markdownRendererCitePrototype}%
%\def\markdownRendererTextCite{%
%  \markdownRendererTextCitePrototype}%
\def\markdownRendererInterblockSeparator{%
  \markdownRendererInterblockSeparatorPrototype}%
%\def\markdownRendererTable{%
%  \markdownRendererTablePrototype}%
\def\markdownRendererCodeSpan{%
  \markdownRendererCodeSpanPrototype}%
\def\markdownRendererLineBreak{%
  \markdownRendererLineBreakPrototype}%
%\def\markdownRendererLink{%
%  \markdownRendererLinkPrototype}%
%
%
%\def\markdownLuaOptions{{%
%\ifx\markdownOptionBlankBeforeBlockquote\undefined\else
%  blankBeforeBlockquote = \markdownOptionBlankBeforeBlockquote,
%\fi
%\ifx\markdownOptionBlankBeforeCodeFence\undefined\else
%  blankBeforeCodeFence = \markdownOptionBlankBeforeCodeFence,
%\fi
%\ifx\markdownOptionBlankBeforeHeading\undefined\else
%  blankBeforeHeading = \markdownOptionBlankBeforeHeading,
%\fi
%\ifx\markdownOptionBreakableBlockquotes\undefined\else
%  breakableBlockquotes = \markdownOptionBreakableBlockquotes,
%\fi
%  cacheDir = "\markdownOptionCacheDir",
%\ifx\markdownOptionCitations\undefined\else
%  citations = \markdownOptionCitations,
%\fi
%\ifx\markdownOptionCitationNbsps\undefined\else
%  citationNbsps = \markdownOptionCitationNbsps,
%\fi
%\ifx\markdownOptionCodeSpans\undefined\else
%  codeSpans = \markdownOptionCodeSpans,
%\fi
%\ifx\markdownOptionContentBlocks\undefined\else
%  contentBlocks = \markdownOptionContentBlocks,
%\fi
%\ifx\markdownOptionContentBlocksLanguageMap\undefined\else
%  contentBlocksLanguageMap =
%    "\markdownOptionContentBlocksLanguageMap",
%\fi
%\ifx\markdownOptionDefinitionLists\undefined\else
%  definitionLists = \markdownOptionDefinitionLists,
%\fi
%\ifx\markdownOptionFootnotes\undefined\else
%  footnotes = \markdownOptionFootnotes,
%\fi
%\ifx\markdownOptionFencedCode\undefined\else
%  fencedCode = \markdownOptionFencedCode,
%\fi
%\ifx\markdownOptionHashEnumerators\undefined\else
%  hashEnumerators = \markdownOptionHashEnumerators,
%\fi
%\ifx\markdownOptionHeaderAttributes\undefined\else
%  headerAttributes = \markdownOptionHeaderAttributes,
%\fi
%\ifx\markdownOptionHtml\undefined\else
%  html = \markdownOptionHtml,
%\fi
%\ifx\markdownOptionHybrid\undefined\else
%  hybrid = \markdownOptionHybrid,
%\fi
%\ifx\markdownOptionInlineFootnotes\undefined\else
%  inlineFootnotes = \markdownOptionInlineFootnotes,
%\fi
%\ifx\markdownOptionPipeTables\undefined\else
%  pipeTables = \markdownOptionPipeTables,
%\fi
%\ifx\markdownOptionPreserveTabs\undefined\else
%  preserveTabs = \markdownOptionPreserveTabs,
%\fi
%\ifx\markdownOptionShiftHeadings\undefined\else
%  shiftHeadings = "\markdownOptionShiftHeadings",
%\fi
%\ifx\markdownOptionSlice\undefined\else
%  slice = "\markdownOptionSlice",
%\fi
%\ifx\markdownOptionSmartEllipses\undefined\else
%  smartEllipses = \markdownOptionSmartEllipses,
%\fi
%\ifx\markdownOptionStartNumber\undefined\else
%  startNumber = \markdownOptionStartNumber,
%\fi
%\ifx\markdownOptionTableCaptions\undefined\else
%  tableCaptions = \markdownOptionTableCaptions,
%\fi
%\ifx\markdownOptionTightLists\undefined\else
%  tightLists = \markdownOptionTightLists,
%\fi
%\ifx\markdownOptionUnderscores\undefined\else
%  underscores = \markdownOptionUnderscores,
%\fi}
%}%
%
%\def\markdownOptionHybrid{true}
%\def\markdownOptionFencedCode{true}
%\def\markdownOptionUnderscores{false}
%
%\def\markdownLuaOptions{{%
%\ifx\markdownOptionBlankBeforeBlockquote\undefined\else
%  blankBeforeBlockquote = \markdownOptionBlankBeforeBlockquote,
%\fi
%\ifx\markdownOptionBlankBeforeCodeFence\undefined\else
%  blankBeforeCodeFence = \markdownOptionBlankBeforeCodeFence,
%\fi
%\ifx\markdownOptionBlankBeforeHeading\undefined\else
%  blankBeforeHeading = \markdownOptionBlankBeforeHeading,
%\fi
%\ifx\markdownOptionBreakableBlockquotes\undefined\else
%  breakableBlockquotes = \markdownOptionBreakableBlockquotes,
%\fi
%  cacheDir = "\markdownOptionCacheDir",
%\ifx\markdownOptionCitations\undefined\else
%  citations = \markdownOptionCitations,
%\fi
%\ifx\markdownOptionCitationNbsps\undefined\else
%  citationNbsps = \markdownOptionCitationNbsps,
%\fi
%\ifx\markdownOptionCodeSpans\undefined\else
%  codeSpans = \markdownOptionCodeSpans,
%\fi
%\ifx\markdownOptionContentBlocks\undefined\else
%  contentBlocks = \markdownOptionContentBlocks,
%\fi
%\ifx\markdownOptionContentBlocksLanguageMap\undefined\else
%  contentBlocksLanguageMap =
%    "\markdownOptionContentBlocksLanguageMap",
%\fi
%\ifx\markdownOptionDefinitionLists\undefined\else
%  definitionLists = \markdownOptionDefinitionLists,
%\fi
%\ifx\markdownOptionFootnotes\undefined\else
%  footnotes = \markdownOptionFootnotes,
%\fi
%\ifx\markdownOptionFencedCode\undefined\else
%  fencedCode = \markdownOptionFencedCode,
%\fi
%\ifx\markdownOptionHashEnumerators\undefined\else
%  hashEnumerators = \markdownOptionHashEnumerators,
%\fi
%\ifx\markdownOptionHeaderAttributes\undefined\else
%  headerAttributes = \markdownOptionHeaderAttributes,
%\fi
%\ifx\markdownOptionHtml\undefined\else
%  html = \markdownOptionHtml,
%\fi
%\ifx\markdownOptionHybrid\undefined\else
%  hybrid = \markdownOptionHybrid,
%\fi
%\ifx\markdownOptionInlineFootnotes\undefined\else
%  inlineFootnotes = \markdownOptionInlineFootnotes,
%\fi
%\ifx\markdownOptionPipeTables\undefined\else
%  pipeTables = \markdownOptionPipeTables,
%\fi
%\ifx\markdownOptionPreserveTabs\undefined\else
%  preserveTabs = \markdownOptionPreserveTabs,
%\fi
%\ifx\markdownOptionShiftHeadings\undefined\else
%  shiftHeadings = "\markdownOptionShiftHeadings",
%\fi
%\ifx\markdownOptionSlice\undefined\else
%  slice = "\markdownOptionSlice",
%\fi
%\ifx\markdownOptionSmartEllipses\undefined\else
%  smartEllipses = \markdownOptionSmartEllipses,
%\fi
%\ifx\markdownOptionStartNumber\undefined\else
%  startNumber = \markdownOptionStartNumber,
%\fi
%\ifx\markdownOptionTableCaptions\undefined\else
%  tableCaptions = \markdownOptionTableCaptions,
%\fi
%\ifx\markdownOptionTightLists\undefined\else
%  tightLists = \markdownOptionTightLists,
%\fi
%\ifx\markdownOptionUnderscores\undefined\else
%  underscores = \markdownOptionUnderscores,
%\fi}
%}%
%
%\def\markdownPrepare{%
%local lfs = require("lfs")
%local cacheDir = "\markdownOptionCacheDir"
%if not lfs.isdir(cacheDir) then
%  assert(lfs.mkdir(cacheDir))
%end
%local md = require("markdown")
%local convert = md.new(\markdownLuaOptions)
%}%
%
%\csname newread\endcsname\markdownInputFileStream
%\csname newwrite\endcsname\markdownOutputFileStream
%
%\begingroup
%  \catcode`\^^I=12%
%  \gdef\markdownReadAndConvertTab{^^I}%
%\endgroup
%
%\begingroup
%  \catcode`\^^M=13%
%  \catcode`\^^I=13%
%  \catcode`|=0%
%  \catcode`\\=12%
%  |catcode`@=14%
%  |catcode`|%=12@
%  |gdef|markdownReadAndConvert#1#2{@
%    |begingroup@
%    |immediate|openout|markdownOutputFileStream@
%      |markdownOptionInputTempFileName|relax@
%    |markdownInfo{Buffering markdown input into the temporary @
%      input file "|markdownOptionInputTempFileName" and scanning @
%      for the closing token sequence "#1"}@
%    |def|do##1{|catcode`##1=12}|dospecials@
%    |catcode`| =12@
%    |markdownMakeOther@
%    |def|markdownReadAndConvertStripPercentSign##1{@
%      |markdownIfOption{StripPercentSigns}@
%        |if##1%@
%          |expandafter|expandafter|expandafter@
%            |markdownReadAndConvertProcessLine@
%        |else@
%          |expandafter|expandafter|expandafter@
%            |markdownReadAndConvertProcessLine@
%            |expandafter|expandafter|expandafter##1@
%        |fi@
%      |else@
%        |expandafter@
%          |markdownReadAndConvertProcessLine@
%          |expandafter##1@
%      |fi}@
%    |def|markdownReadAndConvertProcessLine##1#1##2#1##3|relax{@
%      |ifx|relax##3|relax@
%        |immediate|write|markdownOutputFileStream{##1}@
%      |else@
%        |def^^M{@
%          |markdownInfo{The ending token sequence was found}@
%          |immediate|closeout|markdownOutputFileStream@
%          |endgroup@
%          |markdownInput{@
%            |markdownOptionOutputDir@
%            /|markdownOptionInputTempFileName@
%          }@
%          #2}@
%      |fi@
%      ^^M}@
%    |catcode`|^^I=13@
%    |def^^I{|markdownReadAndConvertTab}@
%    |catcode`|^^M=13@
%    |def^^M##1^^M{@
%      |def^^M####1^^M{@
%        |markdownReadAndConvertStripPercentSign####1#1#1|relax}@
%      ^^M}@
%    ^^M}@
%|endgroup
%
%
%
%\def\markdownOptionOutputTempFileName{test.markdown.out}%
%\begingroup
%\catcode`|=0%
%\catcode`\\=12%
%|gdef|markdownLuaExecute#1{%
%  |immediate|openout|markdownOutputFileStream=%
%    |markdownOptionHelperScriptFileName
%  |immediate|write|markdownOutputFileStream{%
%    local run_ok, error = pcall(function()
%      local kpse = require("kpse")
%      kpse.set_program_name("luatex")
%      #1
%    end)
%  }%
%|immediate|closeout|markdownOutputFileStream
%|immediate|write18{luatex "|markdownOptionOutputDir
%  /|markdownOptionHelperScriptFileName" > %
%  "|markdownOptionOutputDir
%  /|markdownOptionOutputTempFileName"}%
%|input|markdownOptionOutputTempFileName|relax}%
%|endgroup
%
%\begingroup
%  \catcode`|=0%
%  \catcode`\\=12%
%  |gdef|markdownInput#1{%
%    |openin|markdownInputFileStream#1
%    |closein|markdownInputFileStream
%    |markdownLuaExecute{%
%      |markdownPrepare
%      local input = assert(io.open("#1", "r"):read("*a"))
%      print(convert(input:gsub("\r\n?", "\n") .. "\n"))}}%
%|endgroup
%
